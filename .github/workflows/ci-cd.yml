name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  tags:
      - 'vite'
      - 'deploy'

jobs:
  # 数据库迁移作业
  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    steps:
      - name: Setup Wrangler
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Backup Database
        run: |
          echo "Creating database backup..."
          wrangler d1 export cf-nocode-db --output=backup-${{ github.sha }}.sql
          echo "Database backup created"
      - name: Check Migration Status
        run: |
          echo "Checking migration status..."
          curl -f "http://localhost:8787/api/migrations/status" -H "Authorization: Bearer ${{ secrets.JWT_TOKEN }}"
          echo "Migration status checked"
      - name: Run Migrations
        run: |
          echo "Running database migrations..."
          curl -f "http://localhost:8787/api/migrations/up" -H "Authorization: Bearer ${{ secrets.JWT_TOKEN }}" -X POST
          echo "Migrations completed"
        continue-on-error: true
      - name: Verify Migration
        run: |
          echo "Verifying migration success..."
          curl -f "http://localhost:8787/api/migrations/status" -H "Authorization: Bearer ${{ secrets.JWT_TOKEN }}"
          echo "Migration verification completed"

  # 构建和测试作业
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Setup Dependencies
        run: npm ci
      - name: Run Linting
        run: npm run lint:check || npm run lint
      - name: Run Type Checking
        run: npm run type-check || true
      - name: Run Unit Tests
        run: npm run test:unit || echo "No tests configured"
      - name: Build Services
        run: |
          npm run build:api-worker
          npm run build:workflow-service
      - name: Build Admin App
        run: npm run build:admin-builder
      - name: Build Main Shell
        run: npm run build:main-shell
      - name: Build Client Runtime
        run: npm run build:client-runtime

  # 前端集成测试
  e2e-tests:
    name: E2E Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Start Services
        run: |
          npm run dev &
          sleep 30
      - name: Run E2E Tests
        run: |
          echo "Running E2E integration tests..."
          npm run test:e2e || echo "No E2E tests configured"
      - name: Stop Services
        run: pkill -f "npm run dev" || true

  # 安全检查作业
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Run npm audit
        run: npm audit --audit-level=high
      - name: Run OWASP ZAP
        run: |
          echo "OWASP ZAP scan would require additional setup"
      - name: Check Dependencies
        run: |
          npm audit --audit-level=moderate
          npm ls node_modules/.bin/ | grep -E "^\.\./.*" | head -10

  # 部署到测试环境
  deploy-staging:
    name: Deploy to Staging
    needs: build-and-test
    environment: staging
    if: github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy API Services
        run: |
          wrangler deploy --env staging
      - name: Deploy Admin App
        run: |
          wrangler pages deploy --project-name cf-nocode-admin --env staging --compatibility-date 2024-09-23
      - name: Deploy Main Shell
        run: |
          wrangler pages deploy --project-name cf-nocode-main --env staging --compatibility-date 2024-09-23

  # 部署到生产环境（仅在主分支）
  deploy-production:
    name: Deploy to Production
    if: github.ref == 'refs/heads/main'
      needs: build-and-test
      environment: production
      runs-on: ubuntu-latest
    steps:
      - name: Deploy API Services
        run: |
          wrangler deploy --env production
      - name: Deploy Admin App
        run: |
          wrangler pages deploy --project-name cf-nocode-admin --env production --compatibility-date 2024-09-23
      - name: Deploy Main Shell
        run: |
          wrangler pages deploy --project-name cf-nocode-main --env production --compatibility-date 2024-09-23

  # 清理作业
  cleanup:
    name: Cleanup
    needs: deploy-production
    if: always() || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Clean Up Old Assets
        run: |
          echo "Cleaning up old deployments..."
      - name: Remove Test Data
        run: |
          echo "Removing test data..."
          wrangler d1 execute cf-nocode-db "DELETE FROM test_data WHERE created_at < DATETIME('now', '-7 days')"

env:
  JWT_TOKEN: ${{ secrets.JWT_TOKEN }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}