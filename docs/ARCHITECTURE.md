# 项目架构

本文档介绍 Cloudflare Eco No-Code 平台的技术架构、项目结构和最新优化。

## 🏗️ 整体架构

### 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                     Cloudflare Ecosystem                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐      │
│  │   D1 DB     │  │   R2        │  │   Durable Objects   │      │
│  │ (Metadata)  │  │  (Storage)  │  │  (Real-time Sync)   │      │
│  │ (App Data)  │  │  (Files)    │  │ (WebSocket Server)  │      │
│  └─────────────┘  └─────────────┘  └─────────────────────┘      │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 Cloudflare Workers                       │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │  API Worker │  │Storage      │  │ Workflow    │     │  │
│  │  │  (Hono)     │  │ Service     │  │ Service     │     │  │
│  │  │ + Auth      │  │  (R2 API)   │  │ (Triggers)  │     │  │
│  │  │ + GraphQL   │  └─────────────┘  └─────────────┘     │  │
│  │  │ + RBAC      │                                        │  │
│  │  └─────────────┘                                        │  │
│  │  ┌─────────────┐  ┌─────────────┐                       │  │
│  │  │ Realtime    │  │ Migration   │                       │  │
│  │  │ Worker      │  │ Service     │                       │  │
│  │  │ (WebSocket) │  │ (Versioned) │                       │  │
│  │  └─────────────┘  └─────────────┘                       │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 Cloudflare Pages                         │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │ Main Shell  │  │ Admin       │  │ Client      │     │  │
│  │  │  (Vue 3)    │  │ Builder     │  │ Runtime     │     │  │
│  │  │ (Micro-FE)  │  │ (Vue 3)     │  │ (Vue 3)     │     │  │
│  │  │ (Qiankun)   │  │ (Element+)  │  │ (Dynamic)   │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件架构

#### 1. 📊 数据层 (Data Layer)
- **D1 Database**:
  - **元数据存储**: 模型定义、字段配置、页面布局、用户权限
  - **应用数据**: 动态生成的业务表数据
  - **系统数据**: 用户认证、角色权限、审计日志
  - **特性**: ACID 事务、分布式一致性、自动备份

- **R2 Storage**:
  - **文件存储**: 用户上传文件、媒体资源、文档管理
  - **元数据管理**: 文件信息、权限控制、版本历史
  - **CDN 集成**: 全球内容分发、智能缓存
  - **安全性**: 加密存储、访问控制、合规支持

- **Durable Objects**:
  - **实时同步**: WebSocket 连接管理、消息广播
  - **状态管理**: 协作状态、会话信息、实时数据
  - **事件系统**: 数据变更通知、触发器执行
  - **高可用**: 状态持久化、故障恢复

#### 2. 🔧 服务层 (Service Layer)
- **API Worker** (核心服务):
  - **RESTful API**: 完整 CRUD 操作、高级查询、批量操作
  - **GraphQL API**: 灵活查询、类型安全、文档自动生成
  - **认证系统**: JWT 令牌、密码管理、会话控制
  - **权限控制**: RBAC 模型、资源授权、操作审计
  - **数据验证**: 输入校验、业务规则、安全防护

- **Storage Service** (文件管理):
  - **上传下载**: 多部分上传、断点续传、进度跟踪
  - **文件处理**: 格式转换、压缩缩略、元数据提取
  - **权限管理**: 访问控制、分享链接、到期管理
  - **存储优化**: 自动清理、生命周期管理、成本控制

- **Workflow Service** (业务流程):
  - **触发器引擎**: 数据变更、定时任务、外部事件
  - **动作系统**: 邮件通知、Webhook 调用、数据操作
  **流程设计**: 可视化设计器、条件判断、循环处理
  - **执行监控**: 任务跟踪、错误处理、性能统计

- **Realtime Worker** (实时通信):
  - **WebSocket 服务**: 连接管理、心跳检测、重连机制
  - **房间管理**: 频道订阅、权限控制、消息路由
  - **事件广播**: 数据变更、用户操作、系统通知
  - **性能优化**: 消息压缩、批量发送、智能调度

- **Migration Service** (数据库管理):
  - **版本控制**: 迁移脚本、版本跟踪、回滚支持
  - **自动执行**: 环境检测、依赖检查、安全验证
  - **数据保护**: 备份策略、迁移验证、一致性检查
  - **开发工具**: 脚本生成、差异对比、测试支持

#### 3. 🎨 表现层 (Presentation Layer)
- **Main Shell** (应用容器):
  - **微前端架构**: Qiankun 集成、模块隔离、独立部署
  - **路由管理**: 统一路由、懒加载、权限控制
  - **状态共享**: 跨应用通信、全局状态、事件总线
  - **主题系统**: 多主题支持、动态切换、个性化定制

- **Admin Builder** (管理界面):
  - **模型设计器**: 可视化建模、字段配置、关系设计
  - **数据管理**: 高级查询、批量操作、导入导出
  - **用户管理**: 角色配置、权限分配、审计日志
  - **系统设置**: 环境配置、性能监控、安全设置

- **Client Runtime** (应用运行时):
  **动态渲染**: 表单生成、列表展示、详情页面
  - **交互逻辑**: 数据绑定、事件处理、验证规则
  - **响应式设计**: 多设备适配、布局优化、性能优化
  - **离线支持**: 数据缓存、同步机制、离线操作
   - **Admin Builder**: 管理后台，模型设计器
   - **Client Runtime**: 客户端运行时，动态应用

## 📁 项目结构

```
cf-nocode/
├── server/                          # 后端服务
│   ├── api-worker/                  # ✅ 主 API 服务（完全功能）
│   │   ├── model-service.ts         # 模型管理服务
│   │   ├── crud-service.ts          # CRUD操作服务
│   │   ├── graphql.ts               # GraphQL API服务
│   │   ├── index.ts                 # API路由（包含认证）
│   │   ├── migration-service.ts     # 数据库迁移服务
│   │   ├── migrations/              # 数据库迁移文件
│   │   │   ├── 001_create_migration_table.sql
│   │   │   └── 002_create_metadata_tables.sql
│   │   └── schema.sql               # 数据库schema
│   ├── auth-worker/                 # ⚠️ 独立认证服务（可弃用，功能已集成到API服务）
│   │   ├── index.ts                 # 认证API
│   │   ├── schema.sql               # 认证表结构
│   │   └── wrangler.toml            # 部署配置
│   ├── realtime-worker/             # ⚠️ 实时通信服务（基础框架）
│   │   └── index.ts                 # WebSocket实现
│   └── storage-service/             # ⚠️ 存储服务（开发中，目录结构）
├── client/                          # 前端应用
│   ├── main-shell/                  # ⚠️ 主应用壳（基础框架）
│   │   ├── App.vue                  # 主应用组件
│   │   ├── router.ts                # 路由配置
│   │   └── micro-apps.ts            # 微应用配置
│   ├── admin-builder/               # ✅ 管理后台（核心功能）
│   │   ├── AdminHome.vue            # 模型设计器主界面
│   │   ├── UIDesigner.vue           # UI设计器界面
│   │   ├── ModelFieldConfig.vue     # 字段配置组件
│   │   └── formily-config.ts        # Formily配置
│   └── client-runtime/              # ⚠️ 客户端运行时（基础框架）
│       ├── App.vue                  # 客户端应用
│       └── main.ts                  # 客户端入口
├── docs/                            # 📚 项目文档
│   ├── GETTING_STARTED.md           # 快速开始指南
│   ├── FEATURES.md                  # 功能指南
│   ├── API_REFERENCE.md             # API参考文档
│   ├── ARCHITECTURE.md              # 项目架构（本文档）
│   └── DEVELOPMENT.md               # 开发指南
└── 配置文件
    ├── package.json                 # ✅ 根项目配置
    ├── wrangler.toml                # ✅ API服务配置
    ├── tsconfig.json                # ✅ TypeScript配置
    ├── .env.example                 # ✅ 环境变量模板
    ├── .dev.vars                    # ✅ 开发环境变量
    └── README.md                    # ✅ 项目主文档
```

## 🔧 技术栈详解

### 后端技术栈

#### Cloudflare Workers
- **运行时**: V8 JavaScript 引擎
- **优势**: 边缘计算、全球部署、低延迟
- **使用场景**: API 服务、实时通信、文件处理

#### Hono 框架
- **类型**: 轻量级 Web 框架
- **特性**: 高性能、TypeScript 支持、中间件系统
- **使用场景**: RESTful API 路由、中间件处理

#### D1 Database
- **类型**: SQLite 兼容的分布式数据库
- **特性**: 强一致性、ACID 事务、自动备份
- **使用场景**: 应用数据存储、元数据管理

#### Apollo Server
- **类型**: GraphQL 服务器
- **特性**: 类型安全、查询验证、缓存控制
- **使用场景**: 灵活的 GraphQL API

### 前端技术栈

#### Vue 3
- **框架**: 渐进式 JavaScript 框架
- **特性**: 组合式 API、响应式系统、TypeScript 支持
- **使用场景**: 所有前端应用

#### Vite
- **构建工具**: 下一代前端构建工具
- **特性**: 快速冷启动、热模块替换、按需编译
- **使用场景**: 开发服务器和构建

#### Qiankun
- **微前端框架**: 基于 single-spa
- **特性**: 样式隔离、JS 沙箱、资源预加载
- **使用场景**: 微前端架构集成

#### UnoCSS
- **原子化 CSS**: 按需生成的原子 CSS 引擎
- **特性**: 高性能、体积小、可定制
- **使用场景**: 样式系统

#### Element Plus
- **UI 组件库**: 基于 Vue 3 的组件库
- **特性**: 丰富的组件、主题定制、国际化
- **使用场景**: 管理后台界面

#### Formily
- **表单解决方案**: 动态表单和低代码表单
- **特性**: 表单联动、表单验证、JSON Schema
- **使用场景**: 模型字段配置

## 🔄 数据流架构

### 模型创建流程
```
1. 用户在 Admin Builder 创建模型定义
   ↓
2. 通过 REST API 保存到 D1 数据库
   ↓
3. 用户点击"创建表"按钮
   ↓
4. API Worker 生成 SQL 并执行
   ↓
5. 在 D1 中创建物理表
   ↓
6. 自动生成 RESTful 和 GraphQL API
```

### 数据操作流程
```
1. 客户端发送 API 请求
   ↓
2. Cloudflare Workers 接收请求
   ↓
3. 路由到对应的服务处理
   ↓
4. 执行数据库操作 (D1)
   ↓
5. 返回 JSON 响应
   ↓
6. 客户端更新界面
```

### 实时通信流程
```
1. 客户端建立 WebSocket 连接
   ↓
2. 连接到 Realtime Worker
   ↓
3. Worker 创建/获取 Durable Object
   ↓
4. 数据变更时通知所有连接的客户端
   ↓
5. 客户端接收实时更新
```

## 🛡️ 安全架构

### 认证与授权
- **JWT 认证**: 无状态 token 验证
- **密码安全**: SHA-256 哈希加密
- **CORS 配置**: 跨域资源共享控制
- **环境变量**: 敏感信息隔离

### 数据安全
- **SQL 注入防护**: 参数化查询
- **输入验证**: 请求参数验证
- **错误处理**: 不暴露敏感信息
- **HTTPS**: 强制加密传输

### 部署安全
- **环境隔离**: 开发、测试、生产环境分离
- **密钥管理**: Cloudflare Secrets 管理
- **访问控制**: 基于角色的权限控制
- **日志审计**: 操作日志记录

## 📈 扩展性设计

### 水平扩展
- **无状态服务**: Workers 可以无限扩展
- **分布式数据库**: D1 自动处理数据分片
- **边缘计算**: 全球部署，就近服务

### 垂直扩展
- **微服务架构**: 服务按功能分离
- **插件系统**: 支持功能扩展
- **API 网关**: 统一的 API 入口

### 性能优化
- **缓存策略**: 边缘缓存和内存缓存
- **懒加载**: 按需加载资源
- **代码分割**: 减少初始加载体积
- **CDN 加速**: 静态资源全球分发

## 🔗 集成能力

### 第三方服务集成
- **身份提供商**: OAuth 2.0 集成
- **消息服务**: 邮件、短信、推送
- **支付网关**: Stripe、支付宝等
- **云存储**: AWS S3、Google Cloud Storage

### 开发工具集成
- **CI/CD**: GitHub Actions、GitLab CI
- **监控告警**: Sentry、Datadog
- **文档生成**: Swagger、TypeDoc
- **测试框架**: Jest、Vitest

## 🚀 部署架构

### 开发环境
- **本地开发**: Wrangler CLI 本地模拟
- **热重载**: 代码变更自动重启
- **调试工具**: 浏览器开发者工具

### 测试环境
- **预览部署**: Cloudflare Pages 预览
- **集成测试**: 自动化测试套件
- **性能测试**: 负载测试和压力测试

### 生产环境
- **全球部署**: Cloudflare 全球网络
- **自动扩展**: 根据流量自动调整
- **监控告警**: 实时监控和异常告警
- **备份恢复**: 数据备份和灾难恢复

## 📚 相关文档

- [快速开始指南](./GETTING_STARTED.md) - 环境设置和项目运行
- [功能指南](./FEATURES.md) - 平台功能详细介绍
- [API 参考](./API_REFERENCE.md) - 详细的 API 文档
- [开发指南](./DEVELOPMENT.md) - 贡献指南和开发路线图
